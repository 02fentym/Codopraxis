{% extends "main.html" %}
{% block title %}Run Script Question{% endblock %}
{% block content %}

<!-- Speed: preconnect to CDN -->
<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
<link rel="dns-prefetch" href="//cdn.jsdelivr.net">

<div class="max-w-5xl mx-auto space-y-6">

  <h1 class="text-2xl font-bold">Run Script Question</h1>

  <!-- Submission Form -->
  <div class="card bg-base-200">
    <div class="card-body">
      <!-- novalidate: avoid hidden required field issue -->
      <form method="post" class="space-y-4" id="submission-form" novalidate>
        {% csrf_token %}

        <!-- Keep Django textarea for POST; hide it (Ace syncs its value) -->
        <div class="hidden">
          {{ form.code }}
        </div>

        <!-- Ace editor container -->
        <label class="form-control">
          <div class="label">
            <span class="label-text">Your solution (Python)</span>
          </div>
          <div id="ace-editor"
               class="w-full rounded-box ring-1 ring-base-300 bg-base-100"
               style="height: 28rem;">
          </div>
        </label>

        <div class="card-actions justify-end">
          <button class="btn btn-primary">Run Tests</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Results -->
  {% if results %}
    {% if results.error %}
      <div class="alert alert-error"><span>{{ results.error }}</span></div>
    {% else %}
      <div class="card bg-base-200">
        <div class="card-body">
          <div class="flex items-center gap-3">
            <h2 class="card-title">Results</h2>
            <div class="badge badge-success">Passed {{ results.passed }}/{{ results.total }}</div>
            {% if results.failed %}<div class="badge badge-error">Failed {{ results.failed }}</div>{% endif %}
          </div>

          <div class="overflow-x-auto">
            <table class="table table-zebra">
              <thead>
                <tr>
                  <th>#</th>
                  <th>Input</th>
                  <th>Expected</th>
                  <th>Stdout</th>
                  <th>Stderr</th>
                  <th>Status</th>
                  <th>Timeout</th>
                  <th>RC</th>
                </tr>
              </thead>
              <tbody>
                {% for r in results.results %}
                <tr>
                  <td class="align-top">{{ r.case }}</td>
                  <td class="align-top"><pre class="text-xs">{{ r.input }}</pre></td>
                  <td class="align-top"><pre class="text-xs">{{ r.expected }}</pre></td>
                  <td class="align-top"><pre class="text-xs">{{ r.stdout }}</pre></td>
                  <td class="align-top"><pre class="text-xs">{{ r.stderr }}</pre></td>
                  <td class="align-top">
                    {% if r.passed %}
                      <span class="badge badge-success">Passed</span>
                    {% else %}
                      <span class="badge badge-error">Failed</span>
                    {% endif %}
                  </td>
                  <td class="align-top">{{ r.timeout }}</td>
                  <td class="align-top">{{ r.returncode }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>

        </div>
      </div>
    {% endif %}
  {% endif %}

</div>

<!-- Ace (lightweight) -->
<script src="https://cdn.jsdelivr.net/npm/ace-builds@1.36.2/src-min-noconflict/ace.js"></script>
<script src="https://cdn.jsdelivr.net/npm/ace-builds@1.36.2/src-min-noconflict/mode-python.js"></script>
<script src="https://cdn.jsdelivr.net/npm/ace-builds@1.36.2/src-min-noconflict/theme-github.js"></script>
<script src="https://cdn.jsdelivr.net/npm/ace-builds@1.36.2/src-min-noconflict/theme-monokai.js"></script>

<script>
  (function () {
    const hiddenTextarea = document.getElementById("id_code");
    if (hiddenTextarea) hiddenTextarea.removeAttribute('required'); // avoid hidden required field HTML5 error

    const container = document.getElementById("ace-editor");

    function currentAceTheme() {
      const theme = document.documentElement.getAttribute("data-theme") || "";
      return /dark/i.test(theme) ? "ace/theme/monokai" : "ace/theme/github";
    }

    // Initialize Ace
    const editor = ace.edit(container);
    editor.setOptions({
      mode: "ace/mode/python",
      theme: currentAceTheme(),
      value: hiddenTextarea ? hiddenTextarea.value : "",
      fontSize: "14px",
      wrap: true,
      showPrintMargin: false,
      tabSize: 4,
      useSoftTabs: true,
      useWorker: false, // lighter (no JS worker)
    });

    // Keep editor sized if container changes
    const ro = new ResizeObserver(() => editor.resize());
    ro.observe(container);

    // Sync theme if DaisyUI theme toggles
    const mo = new MutationObserver(() => {
      editor.setTheme(currentAceTheme());
      editor.resize();
    });
    mo.observe(document.documentElement, { attributes: true, attributeFilter: ['data-theme'] });

    // Live-sync editor â†’ hidden textarea
    editor.session.on('change', () => {
      if (hiddenTextarea) hiddenTextarea.value = editor.getValue();
    });

    // Also sync on submit
    const form = document.getElementById("submission-form");
    form.addEventListener("submit", () => {
      if (hiddenTextarea) hiddenTextarea.value = editor.getValue();
    });
  })();
</script>

{% endblock %}
